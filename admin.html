<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIM Admin Panel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-body">

<div class="admin-container">
    <div id="login-screen" class="admin-card login-card">
        <h1>AIM Admin</h1>
        <p style="color: var(--text-muted); margin-bottom: 30px;">–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å (12345)" class="admin-input big-input" onkeyup="if(event.key === 'Enter') checkPassword()">
        <button onclick="checkPassword()" class="admin-btn primary-btn" style="width: 100%;">–í–æ–π—Ç–∏</button>
        <p id="login-error" style="color: var(--danger); margin-top: 15px; display: none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="admin-header">
            <h2 style="color: var(--accent);">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ú–µ–Ω—é</h2>
            <button onclick="logout()" class="admin-btn text-btn">–í—ã–π—Ç–∏</button>
        </header>

        <section class="admin-section admin-card">
            <div class="section-header">
                <h3>üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h3>
            </div>

            <div class="form-card">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                <div class="form-grid">
                    <input type="text" id="cat-name-ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)" class="admin-input">
                    <input type="text" id="cat-name-en" placeholder="Name (EN)" class="admin-input">
                    <input type="text" id="cat-image" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É" class="admin-input full-grid">
                    <button onclick="addCategory()" class="admin-btn primary-btn full-grid">–î–æ–±–∞–≤–∏—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                </div>
            </div>

            <h4 style="margin-top: 20px;">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</h4>
            <div id="admin-categories-list" class="admin-list">
                <div class="empty-state" id="empty-categories-state">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>
            </div>
        </section>

        <section id="items-section" class="admin-section hidden admin-card" style="margin-top: 30px;">
            <div class="section-header">
                <h3>‚òïÔ∏è –¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: <span id="current-cat-name" style="color: var(--accent);">...</span></h3>
            </div>

            <div class="form-card">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h4>
                <div class="form-grid">
                    <input type="text" id="item-name-ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)" class="admin-input">
                    <input type="text" id="item-name-en" placeholder="Name (EN)" class="admin-input">
                    <input type="text" id="item-desc-ru" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (RU)" class="admin-input full-grid">
                    <input type="text" id="item-desc-en" placeholder="Description (EN)" class="admin-input full-grid">
                    <input type="number" id="item-price" placeholder="–¶–µ–Ω–∞ (250)" class="admin-input">
                    <input type="text" id="item-image" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É" class="admin-input">
                    <button onclick="addItem()" class="admin-btn primary-btn full-grid">–î–æ–±–∞–≤–∏—Ç—å –¢–æ–≤–∞—Ä</button>
                </div>
            </div>

            <h4 style="margin-top: 20px;">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤:</h4>
            <div id="admin-items-list" class="admin-list">
                <div class="empty-state" id="empty-items-state">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</div>
            </div>
        </section>
    </div>
</div>

<script>
    let currentCatId = null;

    // === –õ–û–ì–ò–ö–ê –í–•–û–î–ê ===
    function checkPassword() {
        const pass = document.getElementById('admin-pass').value;
        const errorMsg = document.getElementById('login-error');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç.–∫. —ç—Ç–æ –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω—é)
        if(pass === '12345') {
            localStorage.setItem('adminLoggedIn', 'true');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadCategories(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
        } else {
            errorMsg.style.display = 'block';
            errorMsg.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
        }
    }

    function logout() {
        localStorage.removeItem('adminLoggedIn');
        location.reload();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        if(localStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadCategories();
        }
    };

    // === –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò ===

    async function loadCategories() {
        try {
            const res = await fetch('/api/categories');
            const categories = await res.json();
            const list = document.getElementById('admin-categories-list');
            list.innerHTML = '';

            if (categories.length === 0) {
                list.innerHTML = '<div class="empty-state">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
                return;
            }

            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'admin-list-item';
                div.innerHTML = `
                    <img src="${cat.image || 'https://via.placeholder.com/60?text=Cat'}" onerror="this.onerror=null; this.src='https://via.placeholder.com/60?text=Cat'">
                    <div class="item-details">
                        <span class="ru">${cat.name_ru}</span>
                        <span class="en" style="font-style: italic;">${cat.name_en}</span>
                    </div>
                    <button onclick="selectCategory(${cat.id}, '${cat.name_ru.replace(/'/g, "\\'")}')" class="admin-btn primary-btn icon-btn" style="margin-right: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-open"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                    </button>
                    <button onclick="deleteCategory(${cat.id})" class="admin-btn delete-btn icon-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="empty-state" style="color: var(--danger);">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ server.js –∑–∞–ø—É—â–µ–Ω.</div>';
        }
    }

    async function addCategory() {
        const name_ru = document.getElementById('cat-name-ru').value;
        const name_en = document.getElementById('cat-name-en').value;
        const image = document.getElementById('cat-image').value;

        if(!name_ru) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');

        await fetch('/api/admin/categories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name_ru, name_en, image})
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
        document.getElementById('cat-name-ru').value = '';
        document.getElementById('cat-name-en').value = '';
        document.getElementById('cat-image').value = '';

        loadCategories();
    }

    async function deleteCategory(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
            await fetch(`/api/admin/categories/${id}`, {method: 'DELETE'});
            loadCategories();
            document.getElementById('items-section').classList.add('hidden');
        }
    }

    function selectCategory(id, name) {
        currentCatId = id;
        document.getElementById('current-cat-name').textContent = name;
        document.getElementById('items-section').classList.remove('hidden');
        loadItems(id);

        // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –∫ —Ç–æ–≤–∞—Ä–∞–º
        document.getElementById('items-section').scrollIntoView({behavior: 'smooth'});
    }

    async function loadItems(catId) {
        const res = await fetch(`/api/items?category_id=${catId}`);
        const items = await res.json();
        const list = document.getElementById('admin-items-list');
        list.innerHTML = '';

        if (items.length === 0) {
            list.innerHTML = '<div class="empty-state">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'admin-list-item';
            div.innerHTML = `
                <img src="${item.image || 'https://via.placeholder.com/60?text=Item'}" onerror="this.onerror=null; this.src='https://via.placeholder.com/60?text=Item'">
                <div class="item-details">
                    <span class="ru">${item.name_ru}</span>
                    <span class="price">${item.price} ‚ÇΩ</span>
                </div>
                <button onclick="deleteItem(${item.id})" class="admin-btn delete-btn icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            `;
            list.appendChild(div);
        });
    }

    async function addItem() {
        if(!currentCatId) return alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!');

        const name_ru = document.getElementById('item-name-ru').value;
        const name_en = document.getElementById('item-name-en').value;
        const description_ru = document.getElementById('item-desc-ru').value;
        const description_en = document.getElementById('item-desc-en').value;
        const price = parseFloat(document.getElementById('item-price').value);
        const image = document.getElementById('item-image').value;

        if(!name_ru || isNaN(price) || price <= 0) return alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ (RU) –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞!');

        await fetch('/api/admin/items', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                category_id: currentCatId,
                name_ru, name_en, description_ru, description_en, price, image
            })
        });

        // –û—á–∏—Å—Ç–∫–∞
        document.getElementById('item-name-ru').value = '';
        document.getElementById('item-name-en').value = '';
        document.getElementById('item-desc-ru').value = '';
        document.getElementById('item-desc-en').value = '';
        document.getElementById('item-price').value = '';
        document.getElementById('item-image').value = '';

        loadItems(currentCatId);
    }

    async function deleteItem(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
            await fetch(`/api/admin/items/${id}`, {method: 'DELETE'});
            loadItems(currentCatId);
        }
    }
</script>
</body>
</html>